<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forecasting - US Economic Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-chart-line me-2"></i>
                US Economic Dashboard
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">
                    <i class="fas fa-home me-1"></i>Dashboard
                </a>
                <a class="nav-link" href="/analysis">
                    <i class="fas fa-chart-bar me-1"></i>Analysis
                </a>
                <a class="nav-link active" href="/forecasting">
                    <i class="fas fa-chart-line me-1"></i>Forecasting
                </a>
                <a class="nav-link" href="/statistics">
                    <i class="fas fa-calculator me-1"></i>Statistics
                </a>
                <a class="nav-link" href="/stress_testing">
                    <i class="fas fa-shield-alt me-1"></i>Stress Testing
                </a>
                <span class="navbar-text me-3">
                    <i class="fas fa-calendar me-1"></i>
                    <span id="current-date"></span>
                </span>
                <button class="btn btn-outline-light btn-sm" onclick="exportData()">
                    <i class="fas fa-download me-1"></i>Export Data
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <h2 class="mb-4">
                    <i class="fas fa-crystal-ball me-2"></i>
                    Economic Forecasting
                </h2>
            </div>
        </div>

        <!-- Forecast Configuration -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-cog me-2"></i>
                            Forecast Configuration
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <label for="forecast-periods" class="form-label">
                                    <strong>Forecast Period:</strong>
                                </label>
                                <div class="input-group">
                                    <input type="range" class="form-range" id="forecast-periods" 
                                           min="6" max="36" value="6" step="6">
                                    <span class="input-group-text" id="period-display">6 months</span>
                                </div>
                                <small class="text-muted">Select forecast period (6 months to 3 years)</small>
                            </div>
                            <div class="col-md-3">
                                <label for="forecast-model" class="form-label">
                                    <strong>Forecast Model:</strong>
                                </label>
                                <select class="form-select" id="forecast-model">
                                    <option value="linear">Linear Regression</option>
                                    <option value="var" selected>VAR Model</option>
                                    <option value="arima">ARIMA Model</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="confidence-level" class="form-label">
                                    <strong>Confidence:</strong>
                                </label>
                                <select class="form-select" id="confidence-level">
                                    <option value="0.90">90%</option>
                                    <option value="0.95" selected>95%</option>
                                    <option value="0.99">99%</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-primary btn-lg w-100" onclick="updateForecast()">
                                    <i class="fas fa-sync-alt me-2"></i>
                                    Update
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- GDP Forecasting -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-dollar-sign me-2"></i>
                            GDP Forecasting
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="gdp-forecast-chart" style="height: 400px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PCE Forecasting -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-shopping-cart me-2"></i>
                            PCE Forecasting
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="pce-forecast-chart" style="height: 400px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Unemployment Forecasting -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-users me-2"></i>
                            Unemployment Rate Forecasting
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="unemployment-forecast-chart" style="height: 400px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VAR Process Visualization -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-cogs me-2"></i>
                            VAR Modeling Process (Notebook Logic)
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>VAR Process:</strong> Original Data → Differencing → VAR Model → Forecast → Reconstruct Levels
                        </div>
                        <div id="var-process-chart" style="height: 500px;"></div>
                    </div>
                </div>
            </div>
        </div>



        <!-- Forecast Summary -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-chart-line me-2"></i>
                            Forecast Summary
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="card bg-primary text-white">
                                    <div class="card-body text-center">
                                        <h6 id="gdp-projection-title">GDP Projection (6 months)</h6>
                                        <h4 id="gdp-projection">Loading...</h4>
                                        <small>Billions of Dollars</small>
                                        <div class="mt-2">
                                            <small id="gdp-confidence">95% Confidence</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-success text-white">
                                    <div class="card-body text-center">
                                        <h6 id="pce-projection-title">PCE Projection (6 months)</h6>
                                        <h4 id="pce-projection">Loading...</h4>
                                        <small>Billions of Dollars</small>
                                        <div class="mt-2">
                                            <small id="pce-confidence">95% Confidence</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-warning text-white">
                                    <div class="card-body text-center">
                                        <h6 id="unemployment-projection-title">Unemployment Projection (6 months)</h6>
                                        <h4 id="unemployment-projection">Loading...</h4>
                                        <small>Percentage</small>
                                        <div class="mt-2">
                                            <small id="unemployment-confidence">95% Confidence</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Forecast Statistics -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="card-title">
                                            <i class="fas fa-info-circle me-2"></i>
                                            Forecast Statistics
                                        </h6>
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="text-center">
                                                    <h6>GDP Trend</h6>
                                                    <p id="gdp-trend" class="mb-0">Loading...</p>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="text-center">
                                                    <h6>PCE Trend</h6>
                                                    <p id="pce-trend" class="mb-0">Loading...</p>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="text-center">
                                                    <h6>Unemployment Trend</h6>
                                                    <p id="unemployment-trend" class="mb-0">Loading...</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loading-spinner" class="loading-overlay">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        class Forecasting {
            constructor() {
                this.forecastPeriods = 6;
                this.confidenceLevel = 0.95;
                this.forecastModel = 'var'; // Default to VAR model
                this.init();
            }

            async init() {
                this.showLoading();
                this.setupEventListeners();
                this.updateProjectionTitles(); // Set initial titles
                await this.loadForecastingData();
                this.hideLoading();
            }

            setupEventListeners() {
                // Forecast period slider
                const periodSlider = document.getElementById('forecast-periods');
                const periodDisplay = document.getElementById('period-display');
                
                periodSlider.addEventListener('input', (e) => {
                    const months = parseInt(e.target.value);
                    this.forecastPeriods = months;
                    periodDisplay.textContent = `${months} months`;
                    
                    // Auto-update forecast when slider changes
                    this.updateForecastPeriods();
                });

                // Forecast model selector
                const modelSelector = document.getElementById('forecast-model');
                modelSelector.addEventListener('change', (e) => {
                    this.forecastModel = e.target.value;
                    // Auto-update forecast when model changes
                    this.updateForecastPeriods();
                });

                // Confidence level selector
                const confidenceSelector = document.getElementById('confidence-level');
                confidenceSelector.addEventListener('change', (e) => {
                    this.confidenceLevel = parseFloat(e.target.value);
                    // Auto-update forecast when confidence changes
                    this.updateForecastPeriods();
                });
            }

            async updateForecastPeriods() {
                // Update all projection titles immediately
                this.updateProjectionTitles();
                
                // Reload forecasting data with new periods
                await this.loadForecastingData();
            }

            updateProjectionTitles() {
                // Update projection titles to show current period and model
                let modelText = 'Linear';
                if (this.forecastModel === 'var') {
                    modelText = 'VAR';
                } else if (this.forecastModel === 'arima') {
                    modelText = 'ARIMA';
                }
                
                document.getElementById('gdp-projection-title').textContent = 
                    `GDP Projection (${this.forecastPeriods} months) - ${modelText}`;
                document.getElementById('pce-projection-title').textContent = 
                    `PCE Projection (${this.forecastPeriods} months) - ${modelText}`;
                document.getElementById('unemployment-projection-title').textContent = 
                    `Unemployment Projection (${this.forecastPeriods} months) - ${modelText}`;
            }

            displayVARForecasts(varResult) {
                // Display VAR model forecasts with EXACT notebook logic
                this.displayVARGDPForecast(varResult);
                this.displayVARPCEForecast(varResult);
                this.displayVARUnemploymentForecast(varResult);
                this.updateVARProjections(varResult);
                this.updateVARStatistics(varResult);
            }

            displayVARGDPForecast(varResult) {
                // Get historical data for context (EXACT notebook method)
                fetch('/api/data')
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            const dates = result.data.map(row => row.observation_date);
                            const gdpValues = result.data.map(row => row.GDP);
                            
                            // Create future dates for projections (EXACT notebook method)
                            const lastDate = new Date(dates[dates.length - 1]);
                            const futureDates = [];
                            for (let i = 1; i <= this.forecastPeriods; i++) {
                                const futureDate = new Date(lastDate);
                                futureDate.setMonth(lastDate.getMonth() + i);
                                futureDates.push(futureDate.toISOString().split('T')[0]);
                            }

                            // Extract VAR forecast values and confidence intervals (EXACT notebook method)
                            const projections = varResult.forecasts.map(f => f.gdp.value);
                            const lowerBounds = varResult.forecasts.map(f => f.gdp.lower_bound);
                            const upperBounds = varResult.forecasts.map(f => f.gdp.upper_bound);

                            const chartData = [
                                {
                                    x: dates,
                                    y: gdpValues,
                                    type: 'scatter',
                                    mode: 'lines+markers',
                                    name: 'Actual GDP',
                                    line: {color: '#1f77b4', width: 2},
                                    marker: {size: 4}
                                },
                                {
                                    x: futureDates,
                                    y: projections,
                                    type: 'scatter',
                                    mode: 'lines+markers',
                                    name: 'Forecast GDP (EXACT Notebook Logic)',
                                    line: {color: '#ff7f0e', width: 2, dash: 'dash'},
                                    marker: {size: 4}
                                },
                                {
                                    x: futureDates,
                                    y: upperBounds,
                                    type: 'scatter',
                                    mode: 'lines',
                                    name: 'Upper Confidence Bound',
                                    line: {color: 'rgba(255, 127, 14, 0.3)', width: 1},
                                    showlegend: false
                                },
                                {
                                    x: futureDates,
                                    y: lowerBounds,
                                    type: 'scatter',
                                    mode: 'lines',
                                    fill: 'tonexty',
                                    fillcolor: 'rgba(255, 127, 14, 0.1)',
                                    name: 'Lower Confidence Bound',
                                    line: {color: 'rgba(255, 127, 14, 0.3)', width: 1},
                                    showlegend: false
                                }
                            ];

                            const layout = {
                                title: `VAR Forecast for GDP (EXACT Notebook Logic)`,
                                xaxis: {title: 'Time'},
                                yaxis: {title: 'GDP (Billions of Dollars)'},
                                template: 'plotly_white',
                                annotations: [{
                                    text: 'Using: df.diff() → VAR() → forecast() → cumsum() + last_values (EXACT notebook method)',
                                    showarrow: false,
                                    xref: 'paper',
                                    yref: 'paper',
                                    x: 0.02,
                                    y: -0.15,
                                    font: {size: 10, color: 'gray'}
                                }]
                            };

                            Plotly.newPlot('gdp-forecast-chart', chartData, layout, {
                                responsive: true,
                                displayModeBar: false
                            });
                        }
                    });
            }

            displayVARPCEForecast(varResult) {
                // Get historical data for context (EXACT notebook method)
                fetch('/api/data')
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            const dates = result.data.map(row => row.observation_date);
                            const pceValues = result.data.map(row => row.Personal_Consumption_Expenditure);
                            
                            // Create future dates for projections (EXACT notebook method)
                            const lastDate = new Date(dates[dates.length - 1]);
                            const futureDates = [];
                            for (let i = 1; i <= this.forecastPeriods; i++) {
                                const futureDate = new Date(lastDate);
                                futureDate.setMonth(lastDate.getMonth() + i);
                                futureDates.push(futureDate.toISOString().split('T')[0]);
                            }

                            // Extract VAR forecast values and confidence intervals (EXACT notebook method)
                            const projections = varResult.forecasts.map(f => f.pce.value);
                            const lowerBounds = varResult.forecasts.map(f => f.pce.lower_bound);
                            const upperBounds = varResult.forecasts.map(f => f.pce.upper_bound);

                            const chartData = [
                                {
                                    x: dates,
                                    y: pceValues,
                                    type: 'scatter',
                                    mode: 'lines+markers',
                                    name: 'Actual PCE',
                                    line: {color: '#2ca02c', width: 2},
                                    marker: {size: 4}
                                },
                                {
                                    x: futureDates,
                                    y: projections,
                                    type: 'scatter',
                                    mode: 'lines+markers',
                                    name: 'Forecast PCE (EXACT Notebook Logic)',
                                    line: {color: '#d62728', width: 2, dash: 'dash'},
                                    marker: {size: 4}
                                },
                                {
                                    x: futureDates,
                                    y: upperBounds,
                                    type: 'scatter',
                                    mode: 'lines',
                                    name: 'Upper Confidence Bound',
                                    line: {color: 'rgba(214, 39, 40, 0.3)', width: 1},
                                    showlegend: false
                                },
                                {
                                    x: futureDates,
                                    y: lowerBounds,
                                    type: 'scatter',
                                    mode: 'lines',
                                    fill: 'tonexty',
                                    fillcolor: 'rgba(214, 39, 40, 0.1)',
                                    name: 'Lower Confidence Bound',
                                    line: {color: 'rgba(214, 39, 40, 0.3)', width: 1},
                                    showlegend: false
                                }
                            ];

                            const layout = {
                                title: `VAR Forecast for Personal Consumption Expenditure (EXACT Notebook Logic)`,
                                xaxis: {title: 'Time'},
                                yaxis: {title: 'Personal Consumption Expenditure (Billions of Dollars)'},
                                template: 'plotly_white',
                                annotations: [{
                                    text: 'Using: df.diff() → VAR() → forecast() → cumsum() + last_values (EXACT notebook method)',
                                    showarrow: false,
                                    xref: 'paper',
                                    yref: 'paper',
                                    x: 0.02,
                                    y: -0.15,
                                    font: {size: 10, color: 'gray'}
                                }]
                            };

                            Plotly.newPlot('pce-forecast-chart', chartData, layout, {
                                responsive: true,
                                displayModeBar: false
                            });
                        }
                    });
            }

            displayVARUnemploymentForecast(varResult) {
                // Get historical data for context (EXACT notebook method)
                fetch('/api/data')
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            const dates = result.data.map(row => row.observation_date);
                            const unempValues = result.data.map(row => row.Unemployment_Rate);
                            
                            // Create future dates for projections (EXACT notebook method)
                            const lastDate = new Date(dates[dates.length - 1]);
                            const futureDates = [];
                            for (let i = 1; i <= this.forecastPeriods; i++) {
                                const futureDate = new Date(lastDate);
                                futureDate.setMonth(lastDate.getMonth() + i);
                                futureDates.push(futureDate.toISOString().split('T')[0]);
                            }

                            // Extract VAR forecast values and confidence intervals (EXACT notebook method)
                            const projections = varResult.forecasts.map(f => f.unemployment.value);
                            const lowerBounds = varResult.forecasts.map(f => f.unemployment.lower_bound);
                            const upperBounds = varResult.forecasts.map(f => f.unemployment.upper_bound);

                            const chartData = [
                                {
                                    x: dates,
                                    y: unempValues,
                                    type: 'scatter',
                                    mode: 'lines+markers',
                                    name: 'Actual Unemployment Rate',
                                    line: {color: '#9467bd', width: 2},
                                    marker: {size: 4}
                                },
                                {
                                    x: futureDates,
                                    y: projections,
                                    type: 'scatter',
                                    mode: 'lines+markers',
                                    name: 'Forecast Unemployment Rate (EXACT Notebook Logic)',
                                    line: {color: '#8c564b', width: 2, dash: 'dash'},
                                    marker: {size: 4}
                                },
                                {
                                    x: futureDates,
                                    y: upperBounds,
                                    type: 'scatter',
                                    mode: 'lines',
                                    name: 'Upper Confidence Bound',
                                    line: {color: 'rgba(140, 86, 75, 0.3)', width: 1},
                                    showlegend: false
                                },
                                {
                                    x: futureDates,
                                    y: lowerBounds,
                                    type: 'scatter',
                                    mode: 'lines',
                                    fill: 'tonexty',
                                    fillcolor: 'rgba(140, 86, 75, 0.1)',
                                    name: 'Lower Confidence Bound',
                                    line: {color: 'rgba(140, 86, 75, 0.3)', width: 1},
                                    showlegend: false
                                }
                            ];

                            const layout = {
                                title: `VAR Forecast for Unemployment Rate (EXACT Notebook Logic)`,
                                xaxis: {title: 'Time'},
                                yaxis: {title: 'Unemployment Rate (%)'},
                                template: 'plotly_white',
                                annotations: [{
                                    text: 'Using: df.diff() → VAR() → forecast() → cumsum() + last_values (EXACT notebook method)',
                                    showarrow: false,
                                    xref: 'paper',
                                    yref: 'paper',
                                    x: 0.02,
                                    y: -0.15,
                                    font: {size: 10, color: 'gray'}
                                }]
                            };

                            Plotly.newPlot('unemployment-forecast-chart', chartData, layout, {
                                responsive: true,
                                displayModeBar: false
                            });
                        }
                    });
            }

            updateVARProjections(varResult) {
                // Update projection values for VAR model
                if (varResult.forecasts.length > 0) {
                    const lastForecast = varResult.forecasts[varResult.forecasts.length - 1];
                    
                    // GDP
                    document.getElementById('gdp-projection').textContent = 
                        `$${lastForecast.gdp.value.toFixed(0)}B`;
                    document.getElementById('gdp-confidence').textContent = 
                        `${(this.confidenceLevel * 100).toFixed(0)}% Confidence`;
                    
                    // PCE
                    document.getElementById('pce-projection').textContent = 
                        `$${lastForecast.pce.value.toFixed(0)}B`;
                    document.getElementById('pce-confidence').textContent = 
                        `${(this.confidenceLevel * 100).toFixed(0)}% Confidence`;
                    
                    // Unemployment
                    document.getElementById('unemployment-projection').textContent = 
                        `${lastForecast.unemployment.value.toFixed(1)}%`;
                    document.getElementById('unemployment-confidence').textContent = 
                        `${(this.confidenceLevel * 100).toFixed(0)}% Confidence`;
                }
            }

            updateVARStatistics(varResult) {
                // Update VAR model statistics
                if (varResult.model_info) {
                    const info = varResult.model_info;
                    document.getElementById('gdp-trend').textContent = 
                        `VAR Model (${info.optimal_lags} lags) - AIC: ${info.aic.toFixed(2)}`;
                    document.getElementById('pce-trend').textContent = 
                        `VAR Model (${info.optimal_lags} lags) - BIC: ${info.bic.toFixed(2)}`;
                    document.getElementById('unemployment-trend').textContent = 
                        `VAR Model (${info.optimal_lags} lags) - Diff: ${info.diff_order}`;
                }
            }

            displayARIMAForecasts(arimaResult) {
                // Display ARIMA model forecasts with EXACT notebook logic
                this.displayARIMAGDPForecast(arimaResult);
                this.displayARIMAPCEForecast(arimaResult);
                this.displayARIMAUnemploymentForecast(arimaResult);
                this.updateARIMAProjections(arimaResult);
                this.updateARIMAStatistics(arimaResult);
            }

            displayARIMAGDPForecast(arimaResult) {
                // Get historical data for context (EXACT notebook method)
                fetch('/api/data')
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            const dates = result.data.map(row => row.observation_date);
                            const gdpValues = result.data.map(row => row.GDP);
                            
                            // Create future dates for projections (EXACT notebook method)
                            const lastDate = new Date(dates[dates.length - 1]);
                            const futureDates = [];
                            for (let i = 1; i <= this.forecastPeriods; i++) {
                                const futureDate = new Date(lastDate);
                                futureDate.setMonth(lastDate.getMonth() + i);
                                futureDates.push(futureDate.toISOString().split('T')[0]);
                            }

                            // Extract ARIMA forecast values and confidence intervals (EXACT notebook method)
                            const projections = arimaResult.forecasts.map(f => f.gdp.value);
                            const lowerBounds = arimaResult.forecasts.map(f => f.gdp.lower_bound);
                            const upperBounds = arimaResult.forecasts.map(f => f.gdp.upper_bound);

                            const chartData = [
                                {
                                    x: dates,
                                    y: gdpValues,
                                    type: 'scatter',
                                    mode: 'lines+markers',
                                    name: 'Actual GDP',
                                    line: {color: '#1f77b4', width: 2},
                                    marker: {size: 4}
                                },
                                {
                                    x: futureDates,
                                    y: projections,
                                    type: 'scatter',
                                    mode: 'lines+markers',
                                    name: 'ARIMA Forecast GDP (EXACT Notebook Logic)',
                                    line: {color: '#ff7f0e', width: 2, dash: 'dash'},
                                    marker: {size: 4}
                                },
                                {
                                    x: futureDates,
                                    y: upperBounds,
                                    type: 'scatter',
                                    mode: 'lines',
                                    name: 'Upper Confidence Bound',
                                    line: {color: 'rgba(255, 127, 14, 0.3)', width: 1},
                                    showlegend: false
                                },
                                {
                                    x: futureDates,
                                    y: lowerBounds,
                                    type: 'scatter',
                                    mode: 'lines',
                                    fill: 'tonexty',
                                    fillcolor: 'rgba(255, 127, 14, 0.1)',
                                    name: 'Lower Confidence Bound',
                                    line: {color: 'rgba(255, 127, 14, 0.3)', width: 1},
                                    showlegend: false
                                }
                            ];

                            const layout = {
                                title: `ARIMA Forecast for GDP (EXACT Notebook Logic)`,
                                xaxis: {title: 'Time'},
                                yaxis: {title: 'GDP (Billions of Dollars)'},
                                template: 'plotly_white',
                                annotations: [{
                                    text: 'Using: ARIMA(1,1,1) → forecast() → confidence intervals (EXACT notebook method)',
                                    showarrow: false,
                                    xref: 'paper',
                                    yref: 'paper',
                                    x: 0.02,
                                    y: -0.15,
                                    font: {size: 10, color: 'gray'}
                                }]
                            };

                            Plotly.newPlot('gdp-forecast-chart', chartData, layout, {
                                responsive: true,
                                displayModeBar: false
                            });
                        }
                    });
            }

            displayARIMAPCEForecast(arimaResult) {
                // Get historical data for context (EXACT notebook method)
                fetch('/api/data')
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            const dates = result.data.map(row => row.observation_date);
                            const pceValues = result.data.map(row => row.Personal_Consumption_Expenditure);
                            
                            // Create future dates for projections (EXACT notebook method)
                            const lastDate = new Date(dates[dates.length - 1]);
                            const futureDates = [];
                            for (let i = 1; i <= this.forecastPeriods; i++) {
                                const futureDate = new Date(lastDate);
                                futureDate.setMonth(lastDate.getMonth() + i);
                                futureDates.push(futureDate.toISOString().split('T')[0]);
                            }

                            // Extract ARIMA forecast values and confidence intervals (EXACT notebook method)
                            const projections = arimaResult.forecasts.map(f => f.pce.value);
                            const lowerBounds = arimaResult.forecasts.map(f => f.pce.lower_bound);
                            const upperBounds = arimaResult.forecasts.map(f => f.pce.upper_bound);

                            const chartData = [
                                {
                                    x: dates,
                                    y: pceValues,
                                    type: 'scatter',
                                    mode: 'lines+markers',
                                    name: 'Actual PCE',
                                    line: {color: '#2ca02c', width: 2},
                                    marker: {size: 4}
                                },
                                {
                                    x: futureDates,
                                    y: projections,
                                    type: 'scatter',
                                    mode: 'lines+markers',
                                    name: 'ARIMA Forecast PCE (EXACT Notebook Logic)',
                                    line: {color: '#d62728', width: 2, dash: 'dash'},
                                    marker: {size: 4}
                                },
                                {
                                    x: futureDates,
                                    y: upperBounds,
                                    type: 'scatter',
                                    mode: 'lines',
                                    name: 'Upper Confidence Bound',
                                    line: {color: 'rgba(214, 39, 40, 0.3)', width: 1},
                                    showlegend: false
                                },
                                {
                                    x: futureDates,
                                    y: lowerBounds,
                                    type: 'scatter',
                                    mode: 'lines',
                                    fill: 'tonexty',
                                    fillcolor: 'rgba(214, 39, 40, 0.1)',
                                    name: 'Lower Confidence Bound',
                                    line: {color: 'rgba(214, 39, 40, 0.3)', width: 1},
                                    showlegend: false
                                }
                            ];

                            const layout = {
                                title: `ARIMA Forecast for Personal Consumption Expenditure (EXACT Notebook Logic)`,
                                xaxis: {title: 'Time'},
                                yaxis: {title: 'Personal Consumption Expenditure (Billions of Dollars)'},
                                template: 'plotly_white',
                                annotations: [{
                                    text: 'Using: ARIMA(1,1,1) → forecast() → confidence intervals (EXACT notebook method)',
                                    showarrow: false,
                                    xref: 'paper',
                                    yref: 'paper',
                                    x: 0.02,
                                    y: -0.15,
                                    font: {size: 10, color: 'gray'}
                                }]
                            };

                            Plotly.newPlot('pce-forecast-chart', chartData, layout, {
                                responsive: true,
                                displayModeBar: false
                            });
                        }
                    });
            }

            displayARIMAUnemploymentForecast(arimaResult) {
                // Get historical data for context (EXACT notebook method)
                fetch('/api/data')
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            const dates = result.data.map(row => row.observation_date);
                            const unempValues = result.data.map(row => row.Unemployment_Rate);
                            
                            // Create future dates for projections (EXACT notebook method)
                            const lastDate = new Date(dates[dates.length - 1]);
                            const futureDates = [];
                            for (let i = 1; i <= this.forecastPeriods; i++) {
                                const futureDate = new Date(lastDate);
                                futureDate.setMonth(lastDate.getMonth() + i);
                                futureDates.push(futureDate.toISOString().split('T')[0]);
                            }

                            // Extract ARIMA forecast values and confidence intervals (EXACT notebook method)
                            const projections = arimaResult.forecasts.map(f => f.unemployment.value);
                            const lowerBounds = arimaResult.forecasts.map(f => f.unemployment.lower_bound);
                            const upperBounds = arimaResult.forecasts.map(f => f.unemployment.upper_bound);

                            const chartData = [
                                {
                                    x: dates,
                                    y: unempValues,
                                    type: 'scatter',
                                    mode: 'lines+markers',
                                    name: 'Actual Unemployment Rate',
                                    line: {color: '#9467bd', width: 2},
                                    marker: {size: 4}
                                },
                                {
                                    x: futureDates,
                                    y: projections,
                                    type: 'scatter',
                                    mode: 'lines+markers',
                                    name: 'ARIMA Forecast Unemployment Rate (EXACT Notebook Logic)',
                                    line: {color: '#8c564b', width: 2, dash: 'dash'},
                                    marker: {size: 4}
                                },
                                {
                                    x: futureDates,
                                    y: upperBounds,
                                    type: 'scatter',
                                    mode: 'lines',
                                    name: 'Upper Confidence Bound',
                                    line: {color: 'rgba(140, 86, 75, 0.3)', width: 1},
                                    showlegend: false
                                },
                                {
                                    x: futureDates,
                                    y: lowerBounds,
                                    type: 'scatter',
                                    mode: 'lines',
                                    fill: 'tonexty',
                                    fillcolor: 'rgba(140, 86, 75, 0.1)',
                                    name: 'Lower Confidence Bound',
                                    line: {color: 'rgba(140, 86, 75, 0.3)', width: 1},
                                    showlegend: false
                                }
                            ];

                            const layout = {
                                title: `ARIMA Forecast for Unemployment Rate (EXACT Notebook Logic)`,
                                xaxis: {title: 'Time'},
                                yaxis: {title: 'Unemployment Rate (%)'},
                                template: 'plotly_white',
                                annotations: [{
                                    text: 'Using: ARIMA(1,1,1) → forecast() → confidence intervals (EXACT notebook method)',
                                    showarrow: false,
                                    xref: 'paper',
                                    yref: 'paper',
                                    x: 0.02,
                                    y: -0.15,
                                    font: {size: 10, color: 'gray'}
                                }]
                            };

                            Plotly.newPlot('unemployment-forecast-chart', chartData, layout, {
                                responsive: true,
                                displayModeBar: false
                            });
                        }
                    });
            }

            updateARIMAProjections(arimaResult) {
                // Update projection values for ARIMA model
                if (arimaResult.forecasts.length > 0) {
                    const lastForecast = arimaResult.forecasts[arimaResult.forecasts.length - 1];
                    
                    // GDP
                    document.getElementById('gdp-projection').textContent = 
                        `$${lastForecast.gdp.value.toFixed(0)}B`;
                    document.getElementById('gdp-confidence').textContent = 
                        `${(this.confidenceLevel * 100).toFixed(0)}% Confidence`;
                    
                    // PCE
                    document.getElementById('pce-projection').textContent = 
                        `$${lastForecast.pce.value.toFixed(0)}B`;
                    document.getElementById('pce-confidence').textContent = 
                        `${(this.confidenceLevel * 100).toFixed(0)}% Confidence`;
                    
                    // Unemployment
                    document.getElementById('unemployment-projection').textContent = 
                        `${lastForecast.unemployment.value.toFixed(1)}%`;
                    document.getElementById('unemployment-confidence').textContent = 
                        `${(this.confidenceLevel * 100).toFixed(0)}% Confidence`;
                }
            }

            updateARIMAStatistics(arimaResult) {
                // Update ARIMA model statistics
                if (arimaResult.model_info) {
                    const gdpInfo = arimaResult.model_info.GDP;
                    const pceInfo = arimaResult.model_info.Personal_Consumption_Expenditure;
                    const unempInfo = arimaResult.model_info.Unemployment_Rate;
                    
                    document.getElementById('gdp-trend').textContent = 
                        `ARIMA(1,1,1) - AIC: ${gdpInfo.aic.toFixed(2)}`;
                    document.getElementById('pce-trend').textContent = 
                        `ARIMA(1,1,1) - AIC: ${pceInfo.aic.toFixed(2)}`;
                    document.getElementById('unemployment-trend').textContent = 
                        `ARIMA(1,1,1) - AIC: ${unempInfo.aic.toFixed(2)}`;
                }
            }

            showError(message) {
                // Display error message to user
                console.error('Forecasting error:', message);
                // You can implement a proper error display here
            }

            showLoading() {
                document.getElementById('loading-spinner').style.display = 'flex';
            }

            hideLoading() {
                document.getElementById('loading-spinner').style.display = 'none';
            }

            async loadForecastingData() {
                try {
                    let endpoint = '';
                    if (this.forecastModel === 'var') {
                        endpoint = `/api/forecasting/var?periods=${this.forecastPeriods}`;
                    } else if (this.forecastModel === 'arima') {
                        endpoint = `/api/forecasting/arima?periods=${this.forecastPeriods}`;
                    } else {
                        endpoint = `/api/forecasting/configurable?periods=${this.forecastPeriods}`;
                    }
                    
                    const response = await fetch(endpoint);
                    const result = await response.json();
                    if (result.success) {
                        if (this.forecastModel === 'var') {
                            this.displayVARForecasts(result);
                        } else if (this.forecastModel === 'arima') {
                            this.displayARIMAForecasts(result);
                        } else {
                            this.displayForecasts(result.forecasts);
                        }
                    } else {
                        console.error('Forecasting error:', result.error);
                        this.showError(result.error);
                    }
                } catch (error) {
                    console.error('Error loading forecasting data:', error);
                    this.showError('Failed to load forecasting data');
                }
            }

            displayForecasts(forecasts) {
                this.displayGDPForecast(forecasts.gdp);
                this.displayPCEForecast(forecasts.pce);
                this.displayUnemploymentForecast(forecasts.unemployment);
                this.updateProjections(forecasts);
                this.updateForecastStatistics(forecasts);
            }

            displayGDPForecast(gdpForecast) {
                // Get historical data for context
                fetch('/api/data')
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            const dates = result.data.map(row => row.observation_date);
                            const gdpValues = result.data.map(row => row.GDP);
                            
                            // Create future dates for projections
                            const lastDate = new Date(dates[dates.length - 1]);
                            const futureDates = [];
                            for (let i = 1; i <= this.forecastPeriods; i++) {
                                const futureDate = new Date(lastDate);
                                futureDate.setMonth(lastDate.getMonth() + i);
                                futureDates.push(futureDate.toISOString().split('T')[0]);
                            }

                            // Extract projection values and confidence intervals
                            const projections = gdpForecast.forecast.projections.map(p => p.value);
                            const lowerBounds = gdpForecast.forecast.projections.map(p => p.lower_bound);
                            const upperBounds = gdpForecast.forecast.projections.map(p => p.upper_bound);

                            const chartData = [
                                {
                                    x: dates,
                                    y: gdpValues,
                                    type: 'scatter',
                                    mode: 'lines+markers',
                                    name: 'Historical GDP',
                                    line: {color: '#1f77b4', width: 2},
                                    marker: {size: 4}
                                },
                                {
                                    x: futureDates,
                                    y: projections,
                                    type: 'scatter',
                                    mode: 'lines+markers',
                                    name: 'GDP Forecast',
                                    line: {color: '#ff7f0e', width: 2, dash: 'dash'},
                                    marker: {size: 6, symbol: 'diamond'}
                                },
                                {
                                    x: futureDates,
                                    y: upperBounds,
                                    type: 'scatter',
                                    mode: 'lines',
                                    name: 'Upper Confidence Bound',
                                    line: {color: 'rgba(255, 127, 14, 0.3)', width: 1},
                                    showlegend: false
                                },
                                {
                                    x: futureDates,
                                    y: lowerBounds,
                                    type: 'scatter',
                                    mode: 'lines',
                                    fill: 'tonexty',
                                    fillcolor: 'rgba(255, 127, 14, 0.1)',
                                    name: 'Lower Confidence Bound',
                                    line: {color: 'rgba(255, 127, 14, 0.3)', width: 1},
                                    showlegend: false
                                }
                            ];

                            const layout = {
                                title: `GDP Forecast (${this.forecastPeriods} Months)`,
                                xaxis: {title: 'Date'},
                                yaxis: {title: 'GDP (Billions of Dollars)'},
                                template: 'plotly_white'
                            };

                            Plotly.newPlot('gdp-forecast-chart', chartData, layout, {
                                responsive: true,
                                displayModeBar: false
                            });
                        }
                    });
            }

            displayPCEForecast(pceForecast) {
                fetch('/api/data')
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            const dates = result.data.map(row => row.observation_date);
                            const pceValues = result.data.map(row => row.Personal_Consumption_Expenditure);
                            
                            const lastDate = new Date(dates[dates.length - 1]);
                            const futureDates = [];
                            for (let i = 1; i <= this.forecastPeriods; i++) {
                                const futureDate = new Date(lastDate);
                                futureDate.setMonth(lastDate.getMonth() + i);
                                futureDates.push(futureDate.toISOString().split('T')[0]);
                            }

                            // Extract projection values and confidence intervals
                            const projections = pceForecast.forecast.projections.map(p => p.value);
                            const lowerBounds = pceForecast.forecast.projections.map(p => p.lower_bound);
                            const upperBounds = pceForecast.forecast.projections.map(p => p.upper_bound);

                            const chartData = [
                                {
                                    x: dates,
                                    y: pceValues,
                                    type: 'scatter',
                                    mode: 'lines+markers',
                                    name: 'Historical PCE',
                                    line: {color: '#2ca02c', width: 2},
                                    marker: {size: 4}
                                },
                                {
                                    x: futureDates,
                                    y: projections,
                                    type: 'scatter',
                                    mode: 'lines+markers',
                                    name: 'PCE Forecast',
                                    line: {color: '#ff7f0e', width: 2, dash: 'dash'},
                                    marker: {size: 6, symbol: 'diamond'}
                                },
                                {
                                    x: futureDates,
                                    y: upperBounds,
                                    type: 'scatter',
                                    mode: 'lines',
                                    name: 'Upper Confidence Bound',
                                    line: {color: 'rgba(255, 127, 14, 0.3)', width: 1},
                                    showlegend: false
                                },
                                {
                                    x: futureDates,
                                    y: lowerBounds,
                                    type: 'scatter',
                                    mode: 'lines',
                                    fill: 'tonexty',
                                    fillcolor: 'rgba(255, 127, 14, 0.1)',
                                    name: 'Lower Confidence Bound',
                                    line: {color: 'rgba(255, 127, 14, 0.3)', width: 1},
                                    showlegend: false
                                }
                            ];

                            const layout = {
                                title: `PCE Forecast (${this.forecastPeriods} Months)`,
                                xaxis: {title: 'Date'},
                                yaxis: {title: 'PCE (Billions of Dollars)'},
                                template: 'plotly_white'
                            };

                            Plotly.newPlot('pce-forecast-chart', chartData, layout, {
                                responsive: true,
                                displayModeBar: false
                            });
                        }
                    });
            }

            displayUnemploymentForecast(unemploymentForecast) {
                fetch('/api/data')
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            const dates = result.data.map(row => row.observation_date);
                            const unempValues = result.data.map(row => row.Unemployment_Rate);
                            
                            const lastDate = new Date(dates[dates.length - 1]);
                            const futureDates = [];
                            for (let i = 1; i <= this.forecastPeriods; i++) {
                                const futureDate = new Date(lastDate);
                                futureDate.setMonth(lastDate.getMonth() + i);
                                futureDates.push(futureDate.toISOString().split('T')[0]);
                            }

                            // Extract projection values and confidence intervals
                            const projections = unemploymentForecast.forecast.projections.map(p => p.value);
                            const lowerBounds = unemploymentForecast.forecast.projections.map(p => p.lower_bound);
                            const upperBounds = unemploymentForecast.forecast.projections.map(p => p.upper_bound);

                            const chartData = [
                                {
                                    x: dates,
                                    y: unempValues,
                                    type: 'scatter',
                                    mode: 'lines+markers',
                                    name: 'Historical Unemployment',
                                    line: {color: '#d62728', width: 2},
                                    marker: {size: 4}
                                },
                                {
                                    x: futureDates,
                                    y: projections,
                                    type: 'scatter',
                                    mode: 'lines+markers',
                                    name: 'Unemployment Forecast',
                                    line: {color: '#ff7f0e', width: 2, dash: 'dash'},
                                    marker: {size: 6, symbol: 'diamond'}
                                },
                                {
                                    x: futureDates,
                                    y: upperBounds,
                                    type: 'scatter',
                                    mode: 'lines',
                                    name: 'Upper Confidence Bound',
                                    line: {color: 'rgba(255, 127, 14, 0.3)', width: 1},
                                    showlegend: false
                                },
                                {
                                    x: futureDates,
                                    y: lowerBounds,
                                    type: 'scatter',
                                    mode: 'lines',
                                    name: 'Lower Confidence Bound',
                                    line: {color: 'rgba(255, 127, 14, 0.3)', width: 1},
                                    showlegend: false
                                }
                            ];

                            const layout = {
                                title: `Unemployment Rate Forecast (${this.forecastPeriods} Months)`,
                                xaxis: {title: 'Date'},
                                yaxis: {title: 'Unemployment Rate (%)'},
                                template: 'plotly_white'
                            };

                            Plotly.newPlot('unemployment-forecast-chart', chartData, layout, {
                                responsive: true,
                                displayModeBar: false
                            });
                        }
                    });
            }

            updateProjections(forecasts) {
                // Update projection values
                if (forecasts.gdp.forecast.projections.length > 0) {
                    const gdpProjection = forecasts.gdp.forecast.projections[forecasts.gdp.forecast.projections.length - 1];
                    document.getElementById('gdp-projection').textContent = 
                        `$${gdpProjection.value.toFixed(0)}B`;
                    document.getElementById('gdp-confidence').textContent = 
                        `${(this.confidenceLevel * 100).toFixed(0)}% Confidence`;
                }

                if (forecasts.pce.forecast.projections.length > 0) {
                    const pceProjection = forecasts.pce.forecast.projections[forecasts.pce.forecast.projections.length - 1];
                    document.getElementById('pce-projection').textContent = 
                        `$${pceProjection.value.toFixed(0)}B`;
                    document.getElementById('pce-confidence').textContent = 
                        `${(this.confidenceLevel * 100).toFixed(0)}% Confidence`;
                }

                if (forecasts.unemployment.forecast.projections.length > 0) {
                    const unempProjection = forecasts.unemployment.forecast.projections[forecasts.unemployment.forecast.projections.length - 1];
                    document.getElementById('unemployment-projection').textContent = 
                        `${unempProjection.value.toFixed(1)}%`;
                    document.getElementById('unemployment-confidence').textContent = 
                        `${(this.confidenceLevel * 100).toFixed(0)}% Confidence`;
                }
            }

            updateForecastStatistics(forecasts) {
                // Update trend information
                if (forecasts.gdp.forecast.slope) {
                    const trend = forecasts.gdp.forecast.slope > 0 ? '↗️ Increasing' : '↘️ Decreasing';
                    const strength = Math.abs(forecasts.gdp.forecast.r_squared);
                    let strengthText = '';
                    if (strength > 0.7) strengthText = ' (Strong)';
                    else if (strength > 0.4) strengthText = ' (Moderate)';
                    else strengthText = ' (Weak)';
                    
                    document.getElementById('gdp-trend').textContent = `${trend}${strengthText}`;
                }

                if (forecasts.pce.forecast.slope) {
                    const trend = forecasts.pce.forecast.slope > 0 ? '↗️ Increasing' : '↘️ Decreasing';
                    const strength = Math.abs(forecasts.pce.forecast.r_squared);
                    let strengthText = '';
                    if (strength > 0.7) strengthText = ' (Strong)';
                    else if (strength > 0.4) strengthText = ' (Moderate)';
                    else strengthText = ' (Weak)';
                    
                    document.getElementById('pce-trend').textContent = `${trend}${strengthText}`;
                }

                if (forecasts.unemployment.forecast.slope) {
                    const trend = forecasts.unemployment.forecast.slope > 0 ? '↗️ Increasing' : '↘️ Decreasing';
                    const strength = Math.abs(forecasts.unemployment.forecast.r_squared);
                    let strengthText = '';
                    if (strength > 0.7) strengthText = ' (Strong)';
                    else if (strength > 0.4) strengthText = ' (Moderate)';
                    else strengthText = ' (Weak)';
                    
                    document.getElementById('unemployment-trend').textContent = `${trend}${strengthText}`;
                }
            }
        }

        // Update forecast function
        async function updateForecast() {
            // Get current forecast periods from slider
            const periods = document.getElementById('forecast-periods').value;
            
            // Update the forecasting instance with new periods
            if (window.forecastingInstance) {
                window.forecastingInstance.forecastPeriods = parseInt(periods);
                await window.forecastingInstance.loadForecastingData();
            }
        }

        // Export data function
        async function exportData() {
            try {
                const response = await fetch('/api/data');
                const result = await response.json();
                if (result.success) {
                    // Create CSV content
                    let csvContent = "Date,GDP (Billions $),PCE (Billions $),Unemployment Rate (%)\n";
                    result.data.forEach(row => {
                        csvContent += `${row.observation_date},${row.GDP},${row.Personal_Consumption_Expenditure},${row.Unemployment_Rate}\n`;
                    });
                    
                    // Create and download CSV file
                    const blob = new Blob([csvContent], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `economic_data_${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    // Show success message
                    const successDiv = document.createElement('div');
                    successDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
                    successDiv.style.cssText = 'top: 20px; right: 20px; z-index: 10000;';
                    successDiv.innerHTML = `
                        Data exported successfully!
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.body.appendChild(successDiv);
                    
                    setTimeout(() => {
                        if (successDiv.parentNode) {
                            successDiv.parentNode.removeChild(successDiv);
                        }
                    }, 3000);
                }
            } catch (error) {
                console.error('Error exporting data:', error);
                alert('Error exporting data');
            }
        }

        // Initialize forecasting
        document.addEventListener('DOMContentLoaded', () => {
            // Set current date
            document.getElementById('current-date').textContent = new Date().toLocaleDateString();
            
            // Create global instance
            window.forecastingInstance = new Forecasting();
        });
    </script>
</body>
</html>
