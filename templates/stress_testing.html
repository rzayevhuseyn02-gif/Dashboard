<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Economic Stress Testing - Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-chart-line me-2"></i>
                US Economic Dashboard
            </a>
            <div class="navbar-nav ms-auto d-flex flex-row align-items-center">
                <a class="nav-link nav-item-custom" href="/">
                    <div class="nav-icon-wrapper">
                        <i class="fas fa-home"></i>
                    </div>
                    <div class="nav-text-wrapper">
                        <div class="nav-text-top">Economic</div>
                        <div class="nav-text-bottom">Overview</div>
                    </div>
                </a>
                <a class="nav-link nav-item-custom" href="/analysis">
                    <div class="nav-icon-wrapper">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    <div class="nav-text-wrapper">
                        <div class="nav-text-bottom">Analysis</div>
                    </div>
                </a>
                <a class="nav-link nav-item-custom" href="/forecasting">
                    <div class="nav-icon-wrapper">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="nav-text-wrapper">
                        <div class="nav-text-bottom">Forecasting</div>
                    </div>
                </a>
                <a class="nav-link nav-item-custom" href="/statistics">
                    <div class="nav-icon-wrapper">
                        <i class="fas fa-calculator"></i>
                    </div>
                    <div class="nav-text-wrapper">
                        <div class="nav-text-bottom">Statistics</div>
                    </div>
                </a>
                <a class="nav-link active nav-item-custom" href="/stress_testing">
                    <div class="nav-icon-wrapper">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <div class="nav-text-wrapper">
                        <div class="nav-text-top">Stress</div>
                        <div class="nav-text-bottom">Testing</div>
                    </div>
                </a>
                <span class="navbar-text me-3 nav-item-custom">
                    <div class="nav-icon-wrapper">
                        <i class="fas fa-calendar"></i>
                    </div>
                    <div class="nav-text-wrapper">
                        <div class="nav-text-top" id="current-date-top"></div>
                        <div class="nav-text-bottom" id="current-date-bottom"></div>
                    </div>
                </span>
                <button class="btn btn-outline-light btn-sm" onclick="exportData()">
                    <i class="fas fa-download me-1"></i>Export Data
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid mt-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="fas fa-shield-alt me-2"></i>
                            Economic Stress Testing
                        </h4>
                        <p class="mb-0 mt-2 opacity-75">Test your economic models against various stress scenarios and market conditions</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Predefined Stress Scenarios -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-fire me-2"></i>
                            Predefined Stress Scenarios
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <div class="card h-100">
                                    <div class="card-body text-center">
                                        <i class="fas fa-fire fa-2x text-danger mb-3"></i>
                                        <h6 class="card-title">Recession Scenario</h6>
                                        <p class="card-text small">Simulate a severe economic downturn with GDP decline, rising unemployment, and falling consumption.</p>
                                         <small class="text-muted d-block mb-2">Duration: 18 months</small>
                                         <small class="text-info d-block mb-2">✓ Fixed % Deviation</small>
                                        <button class="btn btn-primary btn-sm" onclick="runStressTest('recession')">Run Test</button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-3 mb-3">
                                <div class="card h-100">
                                    <div class="card-body text-center">
                                        <i class="fas fa-chart-line-down fa-2x text-warning mb-3"></i>
                                        <h6 class="card-title">Market Crash</h6>
                                        <p class="card-text small">Test against sudden market volatility and rapid economic contraction scenarios.</p>
                                         <small class="text-muted d-block mb-2">Duration: 24 months</small>
                                         <small class="text-info d-block mb-2">✓ Fixed % Deviation</small>
                                        <button class="btn btn-primary btn-sm" onclick="runStressTest('market_crash')">Run Test</button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-3 mb-3">
                                <div class="card h-100">
                                    <div class="card-body text-center">
                                        <i class="fas fa-dollar-sign fa-2x text-info mb-3"></i>
                                        <h6 class="card-title">Inflation Shock</h6>
                                        <p class="card-text small">Simulate high inflation periods with rapid price increases and monetary policy changes.</p>
                                         <small class="text-muted d-block mb-2">Duration: 6 months</small>
                                         <small class="text-info d-block mb-2">✓ Fixed % Deviation</small>
                                        <button class="btn btn-primary btn-sm" onclick="runStressTest('inflation_shock')">Run Test</button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-3 mb-3">
                                <div class="card h-100">
                                    <div class="card-body text-center">
                                        <i class="fas fa-globe fa-2x text-success mb-3"></i>
                                        <h6 class="card-title">Global Crisis</h6>
                                        <p class="card-text small">Test against international economic shocks and global financial instability.</p>
                                         <small class="text-muted d-block mb-2">Duration: 36 months (max)</small>
                                         <small class="text-info d-block mb-2">✓ Fixed % Deviation</small>
                                        <button class="btn btn-primary btn-sm" onclick="runStressTest('global_crisis')">Run Test</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Custom Stress Scenario -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-cogs me-2"></i>
                            Custom Stress Scenario
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label for="gdp-shock" class="form-label">GDP Shock (%)</label>
                                <input type="number" class="form-control" id="gdp-shock" value="-10" step="0.1" min="-50" max="50">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="unemployment-shock" class="form-label">Unemployment Shock (%)</label>
                                <input type="number" class="form-control" id="unemployment-shock" value="5" step="0.1" min="-10" max="20">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="pce-shock" class="form-label">Consumption Shock (%)</label>
                                <input type="number" class="form-control" id="pce-shock" value="-8" step="0.1" min="-30" max="30">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="duration" class="form-label">Duration (months)</label>
                                <select class="form-select" id="duration">
                                    <option value="3">3 months</option>
                                    <option value="6" selected>6 months</option>
                                    <option value="12">12 months</option>
                                    <option value="18">18 months</option>
                                    <option value="24">24 months</option>
                                    <option value="30">30 months</option>
                                    <option value="36">36 months (max)</option>
                                </select>
                                <small class="text-muted">VAR model supports 3-36 months for comprehensive stress analysis and forecasting</small>
                                <small class="text-info d-block mt-1">✓ All scenarios maintain fixed % deviation from baseline</small>
                            </div>
                        </div>
                        <div class="text-center">
                            <button class="btn btn-success btn-lg" onclick="runCustomStressTest()">
                                <i class="fas fa-play me-2"></i>Run Custom Stress Test
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading Section -->
        <div class="row mb-4" id="loading" style="display: none;">
            <div class="col-12 text-center">
                <div class="card">
                    <div class="card-body">
                        <div class="spinner-border text-primary mb-3" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mb-0">Running stress test analysis...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stress Test Results -->
        <div class="row mb-4" id="stress-results" style="display: none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-bar me-2"></i>
                            Stress Test Results
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Results Grid -->
                        <div class="row mb-4" id="results-grid">
                            <!-- Results will be populated here -->
                        </div>
                        
                        <!-- Charts -->
                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">GDP Impact</h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="gdp-chart"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">Unemployment Impact</h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="unemployment-chart"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">Consumption Impact</h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="consumption-chart"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">Risk Metrics</h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="risk-chart"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Comprehensive Chart Section -->
        <div class="row mb-4" id="comprehensive-chart-section" style="display: none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-line me-2"></i>
                            Comprehensive Analysis: Historical + VAR Forecast + Stress Scenarios
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label class="form-label">Indicator:</label>
                                <select id="chart-indicator" class="form-select">
                                    <option value="gdp">GDP</option>
                                    <option value="unemployment">Unemployment Rate</option>
                                    <option value="consumption">Personal Consumption</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <button id="update-chart" class="btn btn-primary w-100">
                                    <i class="fas fa-sync-alt"></i> Update Chart
                                </button>
                            </div>
                            <div class="col-md-6">
                                <div class="alert alert-info small mb-0">
                                    <strong>VAR:</strong> GDP & PCE<br>
                                    <strong>ARIMA:</strong> Unemployment
                                </div>
                            </div>
                        </div>
                        <div id="comprehensive-chart-container">
                            <div id="comprehensive-chart" style="height: 500px;"></div>
                        </div>
                        <div class="mt-3">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="alert alert-info">
                                        <strong>Historical Data:</strong> <span id="historical-range"></span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="alert alert-success">
                                        <strong id="forecast-model-label">ARIMA Forecast:</strong> <span id="forecast-range"></span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="alert alert-warning">
                                        <strong>Stress Scenario:</strong> <span id="stress-info"></span>
                                    </div>
                                </div>
                                                                        <div class="col-md-3">
                                            <div class="alert alert-primary">
                                                <strong>✓ Fixed % Deviation:</strong> All scenarios maintain consistent percentage difference from baseline
                                            </div>
                                        </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

        <!-- EWS System Analysis Section -->
        <div class="row mb-4" id="ews-system-section" style="display: none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            EWS (Early Warning System) Analysis
                        </h5>
                        <p class="mb-0 mt-2 opacity-75">Notebook-based EWS implementation with multiple stress scenarios</p>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Methodology Overview -->
                            <div class="col-md-12 mb-4">
                                <div class="alert alert-info">
                                    <h6><i class="fas fa-info-circle me-2"></i>EWS Methodology</h6>
                                    <ul class="mb-0">
                                        <li><strong>Indicators:</strong> GDP growth, PCE growth, Unemployment change</li>
                                        <li><strong>Standardization:</strong> StandardScaler normalization (mean=0, std=1)</li>
                                        <li><strong>Thresholds:</strong> Mean + 1.5 × Standard Deviation (K=1.5)</li>
                                        <li><strong>Warning Signals:</strong> GDP/PCE below threshold, Unemployment above threshold</li>
                                        <li><strong>EWS Score:</strong> Sum of warning signals (0-3 scale)</li>
                                        <li><strong>Scenarios:</strong> Mild, Moderate, Severe, and Custom stress scenarios</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <!-- Historical Analysis -->
                            <div class="col-md-4 mb-3">
                                <div class="card h-100 border-0 bg-light">
                                    <div class="card-header bg-primary text-white">
                                        <h6 class="mb-0">📊 Historical EWS Analysis</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="text-center mb-3">
                                            <div class="h4 text-primary" id="ews-hist-total-warnings">-</div>
                                            <small class="text-muted">Total Warning Signals</small>
                                        </div>
                                            <div class="row text-center">
                                                <div class="col-4">
                                                <div class="h6 text-danger" id="ews-hist-gdp-warnings">-</div>
                                                    <small class="text-muted">GDP</small>
                                                </div>
                                                <div class="col-4">
                                                <div class="h6 text-warning" id="ews-hist-pce-warnings">-</div>
                                                    <small class="text-muted">Consumption</small>
                                                </div>
                                                <div class="col-4">
                                                <div class="h6 text-info" id="ews-hist-unemp-warnings">-</div>
                                                    <small class="text-muted">Unemployment</small>
                                                </div>
                                            </div>
                                        </div>
                                            </div>
                                        </div>
                                        
                            <!-- Scenario Analysis -->
                            <div class="col-md-8 mb-3">
                                <div class="card">
                                    <div class="card-header bg-success text-white">
                                        <h6 class="mb-0">🎯 Scenario Analysis</h6>
                                                </div>
                                    <div class="card-body">
                                        <div class="row" id="ews-scenario-cards">
                                            <!-- Scenario cards will be populated by JavaScript -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Threshold Information -->
                            <div class="col-md-6 mb-3">
                                <div class="card">
                                    <div class="card-header bg-info text-white">
                                        <h6 class="mb-0">📏 EWS Thresholds (Raw Units)</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="small">
                                            <div class="mb-2">
                                                <strong>GDP Growth:</strong> <span id="ews-gdp-threshold">-</span>
                                            </div>
                                            <div class="mb-2">
                                                <strong>PCE Growth:</strong> <span id="ews-pce-threshold">-</span>
                                            </div>
                                            <div class="mb-2">
                                                <strong>Unemployment Change:</strong> <span id="ews-unemp-threshold">-</span>
                                            </div>
                                            <div class="text-muted mt-2">
                                                <small>K = 1.5 | StandardScaler + Z-score Method</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- EWS Score Chart -->
                            <div class="col-md-6 mb-3">
                                <div class="card">
                                    <div class="card-header bg-warning text-dark">
                                        <h6 class="mb-0">📈 EWS Score Over Time</h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="ews-score-chart" style="height: 200px;"></div>
                                                </div>
                                            </div>
                                        </div>
                                        
                            <!-- Warning Dates Details -->
                            <div class="col-md-12 mt-3">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">📅 Warning Signal Dates by Scenario</h6>
                                                </div>
                                    <div class="card-body">
                                        <div class="row" id="ews-warning-dates">
                                            <!-- Warning dates will be populated by JavaScript -->
                                                </div>
                                                </div>
                                            </div>
                                        </div>
                                                </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        



    </div>

    <script>
        // Global variables
        let currentResults = null;
        
        // Run predefined stress test
        function runStressTest(scenario) {
            showLoading();
            
            // Define scenario parameters (as decimals, not percentages)
            const scenarios = {
                'recession': { gdp: -0.08, unemployment: 0.04, pce: -0.06, duration: 18 },
                'market_crash': { gdp: -0.12, unemployment: 0.06, pce: -0.08, duration: 24 },
                'inflation_shock': { gdp: -0.03, unemployment: 0.01, pce: -0.02, duration: 6 },
                'global_crisis': { gdp: -0.15, unemployment: 0.08, pce: -0.10, duration: 36 }
            };
            
            const params = scenarios[scenario];
            runCustomStressTest(params);
        }
        
        // Run custom stress test
        function runCustomStressTest(customParams = null) {
            showLoading();
            
            let params;
            if (customParams) {
                params = customParams;
            } else {
                // Convert percentage values to decimal (divide by 100)
                params = {
                    gdp: parseFloat(document.getElementById('gdp-shock').value) / 100,
                    unemployment: parseFloat(document.getElementById('unemployment-shock').value) / 100,
                    pce: parseFloat(document.getElementById('pce-shock').value) / 100,
                    duration: parseInt(document.getElementById('duration').value)
                };
            }
            
            // Call API
            fetch(`/api/stress-testing/run`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(params)
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                if (data.success) {
                    displayResults(data.results);
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                hideLoading();
                console.error('Error:', error);
                alert('Error running stress test');
            });
        }
        
        // Display stress test results
        function displayResults(results) {
            currentResults = results;
            
            // Show results section
            document.getElementById('stress-results').style.display = 'block';
            document.getElementById('comprehensive-chart-section').style.display = 'block';
            
            // Populate results grid
            const resultsGrid = document.getElementById('results-grid');
            resultsGrid.innerHTML = `
                <div class="col-md-3 mb-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h6 class="card-title">GDP Impact</h6>
                            <h3 class="text-primary">${results.gdp_impact.toFixed(2)}%</h3>
                            <small class="text-muted ${results.gdp_impact < 0 ? 'text-danger' : 'text-success'}">
                                ${results.gdp_impact < 0 ? '↓' : '↑'} ${Math.abs(results.gdp_impact).toFixed(2)}%
                            </small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h6 class="card-title">Unemployment Impact</h6>
                            <h3 class="text-warning">${results.unemployment_impact.toFixed(2)}%</h3>
                            <small class="text-muted ${results.unemployment_impact > 0 ? 'text-danger' : 'text-success'}">
                                ${results.unemployment_impact > 0 ? '↑' : '↓'} ${Math.abs(results.unemployment_impact).toFixed(2)}%
                            </small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h6 class="card-title">Consumption Impact</h6>
                            <h3 class="text-info">${results.consumption_impact.toFixed(2)}%</h3>
                            <small class="text-muted ${results.consumption_impact < 0 ? 'text-danger' : 'text-success'}">
                                ${results.consumption_impact < 0 ? '↓' : '↑'} ${Math.abs(results.consumption_impact).toFixed(2)}%
                            </small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h6 class="card-title">Risk Score</h6>
                            <h3 class="text-secondary">${results.risk_score.toFixed(1)}</h3>
                            <small class="text-muted">${getRiskLevel(results.risk_score)}</small>
                        </div>
                    </div>
                </div>
            `;
            
            // Create charts
            createCharts(results);
            
            // Load comprehensive chart data
            loadComprehensiveChartData(results);
            

            
            // Load EWS system analysis
            loadEWSSystemAnalysis(results);
            

        }
        
        // Create visualization charts
        function createCharts(results) {
            console.log("=== FRONTEND DEBUG ===");
            console.log("Results:", results);
            
            // Check if baseline_forecast exists, if not use simple trajectory charts
            if (!results.baseline_forecast) {
                console.log("No baseline_forecast found, using simple trajectory charts");
                
                // GDP Trajectory Chart
                const gdpData = [
                    {
                        x: results.time_periods,
                        y: results.gdp_trajectory,
                        type: 'scatter',
                        mode: 'lines+markers',
                        name: 'GDP Impact',
                        line: { color: '#d62728', width: 3 },
                        marker: { size: 6 }
                    }
                ];
                
                const gdpLayout = {
                    title: 'GDP Impact Over Time',
                    xaxis: { title: 'Time Period (months)' },
                    yaxis: { title: 'GDP Change (%)' },
                    template: 'plotly_white',
                    height: 300,
                    legend: { x: 0.02, y: 0.98 }
                };
                
                Plotly.newPlot('gdp-chart', gdpData, gdpLayout);
                
                // Unemployment Trajectory Chart
                const unemploymentData = [
                    {
                        x: results.time_periods,
                        y: results.unemployment_trajectory,
                        type: 'scatter',
                        mode: 'lines+markers',
                        name: 'Unemployment Impact',
                        line: { color: '#ff7f0e', width: 3 },
                        marker: { size: 6 }
                    }
                ];
                
                const unemploymentLayout = {
                    title: 'Unemployment Impact Over Time',
                    xaxis: { title: 'Time Period (months)' },
                    yaxis: { title: 'Unemployment Change (%)' },
                    template: 'plotly_white',
                    height: 300,
                    legend: { x: 0.02, y: 0.98 }
                };
                
                Plotly.newPlot('unemployment-chart', unemploymentData, unemploymentLayout);
                
                // Consumption Trajectory Chart
                const consumptionData = [
                    {
                        x: results.time_periods,
                        y: results.consumption_trajectory,
                        type: 'scatter',
                        mode: 'lines+markers',
                        name: 'Consumption Impact',
                        line: { color: '#2ca02c', width: 3 },
                        marker: { size: 6 }
                    }
                ];
                
                const consumptionLayout = {
                    title: 'Consumption Impact Over Time',
                    xaxis: { title: 'Time Period (months)' },
                    yaxis: { title: 'Consumption Change (%)' },
                    template: 'plotly_white',
                    height: 300,
                    legend: { x: 0.02, y: 0.98 }
                };
                
                Plotly.newPlot('consumption-chart', consumptionData, consumptionLayout);
                
                return;
            }
            
            // If baseline_forecast exists, use comparison charts
            console.log("Baseline GDP:", results.baseline_forecast.gdp);
            console.log("GDP Trajectory:", results.gdp_trajectory);
            console.log("=== END FRONTEND DEBUG ===");
            
            // GDP Comparison Chart (Baseline vs Stressed)
            const gdpData = [
                {
                x: results.time_periods,
                y: results.gdp_trajectory,
                type: 'scatter',
                mode: 'lines+markers',
                    name: 'Stressed GDP',
                    line: { color: '#d62728', width: 3 },
                marker: { size: 6 }
                },
                {
                    x: results.time_periods,
                    y: results.baseline_forecast.gdp.map((val, index) => {
                        // Convert baseline forecast to percentage change from first value
                        const firstValue = results.baseline_forecast.gdp[0];
                        const percentageChange = ((val - firstValue) / firstValue) * 100;
                        console.log(`Baseline GDP ${index}: ${val} -> ${percentageChange}%`);
                        return percentageChange;
                    }),
                    type: 'scatter',
                    mode: 'lines',
                    name: 'VAR Baseline GDP',
                    line: { color: '#1f77b4', width: 2, dash: 'dash' },
                    marker: { size: 4 }
                }
            ];
            
            const gdpLayout = {
                title: 'GDP: VAR Baseline vs Stressed Scenario',
                xaxis: { title: 'Time Period (months)' },
                yaxis: { title: 'GDP Change (%)' },
                template: 'plotly_white',
                height: 300,
                legend: { x: 0.02, y: 0.98 }
            };
            
            Plotly.newPlot('gdp-chart', gdpData, gdpLayout);
            
            // Unemployment Comparison Chart
            const unemploymentData = [
                {
                x: results.time_periods,
                y: results.unemployment_trajectory,
                type: 'scatter',
                mode: 'lines+markers',
                    name: 'Stressed Unemployment',
                line: { color: '#d62728', width: 3 },
                marker: { size: 6 }
                },
                {
                    x: results.time_periods,
                    y: results.baseline_forecast.unemployment.map((val, index) => {
                        // Convert baseline forecast to percentage change from first value
                        const firstValue = results.baseline_forecast.unemployment[0];
                        return ((val - firstValue) / firstValue) * 100;
                    }),
                    type: 'scatter',
                    mode: 'lines',
                    name: 'VAR Baseline Unemployment',
                    line: { color: '#ff7f0e', width: 2, dash: 'dash' },
                    marker: { size: 4 }
                }
            ];
            
            const unemploymentLayout = {
                title: 'Unemployment: VAR Baseline vs Stressed Scenario',
                xaxis: { title: 'Time Period (months)' },
                yaxis: { title: 'Unemployment Change (%)' },
                template: 'plotly_white',
                height: 300,
                legend: { x: 0.02, y: 0.98 }
            };
            
            Plotly.newPlot('unemployment-chart', unemploymentData, unemploymentLayout);
            
            // Consumption Comparison Chart
            const consumptionData = [
                {
                x: results.time_periods,
                y: results.consumption_trajectory,
                type: 'scatter',
                mode: 'lines+markers',
                    name: 'Stressed Consumption',
                    line: { color: '#d62728', width: 3 },
                marker: { size: 6 }
                },
                {
                    x: results.time_periods,
                    y: results.baseline_forecast.consumption.map((val, index) => {
                        // Convert baseline forecast to percentage change from first value
                        const firstValue = results.baseline_forecast.consumption[0];
                        return ((val - firstValue) / firstValue) * 100;
                    }),
                    type: 'scatter',
                    mode: 'lines',
                    name: 'VAR Baseline Consumption',
                    line: { color: '#2ca02c', width: 2, dash: 'dash' },
                    marker: { size: 4 }
                }
            ];
            
            const consumptionLayout = {
                title: 'Consumption: VAR Baseline vs Stressed Scenario',
                xaxis: { title: 'Time Period (months)' },
                yaxis: { title: 'Consumption Change (%)' },
                template: 'plotly_white',
                height: 300,
                legend: { x: 0.02, y: 0.98 }
            };
            
            Plotly.newPlot('consumption-chart', consumptionData, consumptionLayout);
            
            // Risk Metrics Chart
            const riskData = [{
                x: ['GDP Risk', 'Unemployment Risk', 'Consumption Risk', 'Overall Risk'],
                y: [results.gdp_risk, results.unemployment_risk, results.consumption_risk, results.risk_score],
                type: 'bar',
                marker: {
                    color: ['#ff7f0e', '#d62728', '#2ca02c', '#667eea']
                }
            }];
            
            const riskLayout = {
                title: 'Risk Assessment by Category',
                xaxis: { title: 'Risk Categories' },
                yaxis: { title: 'Risk Score' },
                template: 'plotly_white',
                height: 300
            };
            
            Plotly.newPlot('risk-chart', riskData, riskLayout);
        }
        
        // Load comprehensive chart data
        function loadComprehensiveChartData(results) {
            // Check if stress_parameters exists
            if (!results.stress_parameters) {
                console.log("No stress_parameters found, skipping comprehensive chart");
                return;
            }
            
            const params = {
                gdp: results.stress_parameters.gdp_shock,
                unemployment: results.stress_parameters.unemployment_shock,
                pce: results.stress_parameters.pce_shock,
                duration: results.stress_parameters.duration
            };
            
            // Determine which endpoint to use based on selected indicator
            const indicator = document.getElementById('chart-indicator').value;
            const forecastModel = indicator === 'unemployment' ? 'arima' : 'var';
            const endpoint = forecastModel === 'arima' ? '/api/stress-testing/arima-chart-data' : '/api/stress-testing/chart-data';
            
            fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(params)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    createComprehensiveChart(data.chart_data, forecastModel);
                } else {
                    console.error('Error loading chart data:', data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
        
        // Create comprehensive chart
        function createComprehensiveChart(chartData, forecastModel = 'var') {
            const indicator = document.getElementById('chart-indicator').value;
            
            // Prepare data based on selected indicator
            let historicalValues, baselineValues, stressedValues;
            let yAxisTitle;
            
            switch(indicator) {
                case 'gdp':
                    historicalValues = chartData.historical.gdp;
                    baselineValues = chartData.baseline.gdp;
                    stressedValues = chartData.stressed.gdp;
                    yAxisTitle = 'GDP (Billions of Dollars)';
                    break;
                case 'unemployment':
                    historicalValues = chartData.historical.unemployment;
                    baselineValues = chartData.baseline.unemployment;
                    stressedValues = chartData.stressed.unemployment;
                    yAxisTitle = 'Unemployment Rate (%)';
                    break;
                case 'consumption':
                    historicalValues = chartData.historical.consumption;
                    baselineValues = chartData.baseline.consumption;
                    stressedValues = chartData.stressed.consumption;
                    yAxisTitle = 'Personal Consumption (Billions of Dollars)';
                    break;
            }
            
            // Determine forecast model name for display
            const forecastModelName = forecastModel === 'arima' ? 'ARIMA' : 'VAR';
            const forecastModelLabel = forecastModel === 'arima' ? 'ARIMA Baseline Forecast' : 'VAR Baseline Forecast';
            
            // Create chart data
            const data = [
                {
                    x: chartData.historical.dates,
                    y: historicalValues,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Historical Data',
                    line: { color: '#1f77b4', width: 2 },
                    marker: { size: 4 }
                },
                {
                    x: chartData.baseline.dates,
                    y: baselineValues,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: forecastModelLabel,
                    line: { color: '#2ca02c', width: 2, dash: 'dash' },
                    marker: { size: 4 }
                },
                {
                    x: chartData.stressed.dates,
                    y: stressedValues,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Stress Scenario',
                    line: { color: '#d62728', width: 2 },
                    marker: { size: 4 }
                }
            ];
            
            // Add model info annotation for ARIMA
            let annotations = [];
            if (forecastModel === 'arima' && chartData.model_info && chartData.model_info.unemployment_arima) {
                const arimaInfo = chartData.model_info.unemployment_arima;
                annotations.push({
                    text: `ARIMA(${arimaInfo.order.join(',')}) - AIC: ${arimaInfo.aic.toFixed(2)}`,
                    showarrow: false,
                    xref: 'paper',
                    yref: 'paper',
                    x: 0.02,
                    y: -0.15,
                    font: { size: 10, color: 'gray' }
                });
            }
            
            // Create title based on model and indicator
            let title;
            if (forecastModel === 'arima') {
                title = `${indicator.toUpperCase()}: Historical Data + ARIMA Forecast + Stress Scenario`;
            } else {
                title = `${indicator.toUpperCase()}: Historical Data + VAR Forecast + Stress Scenario`;
            }
            
            const layout = {
                title: title,
                xaxis: { title: 'Date' },
                yaxis: { title: yAxisTitle },
                template: 'plotly_white',
                height: 500,
                legend: { x: 0.02, y: 0.98 },
                hovermode: 'x unified',
                annotations: annotations
            };
            
            Plotly.newPlot('comprehensive-chart', data, layout);
            
            // Update info panels
            document.getElementById('historical-range').textContent = 
                `${chartData.historical.dates[0]} to ${chartData.historical.dates[chartData.historical.dates.length-1]}`;
            document.getElementById('forecast-range').textContent = 
                `${chartData.baseline.dates[0]} to ${chartData.baseline.dates[chartData.baseline.dates.length-1]}`;
            document.getElementById('stress-info').textContent = 
                `GDP: ${(chartData.stress_parameters?.gdp_shock * 100).toFixed(1)}%, Unemployment: ${(chartData.stress_parameters?.unemployment_shock * 100).toFixed(1)}%, PCE: ${(chartData.stress_parameters?.pce_shock * 100).toFixed(1)}%`;
            
            // Update forecast model label
            document.getElementById('forecast-model-label').textContent = `${forecastModelName} Forecast:`;
        }
        
        // Get risk level description
        function getRiskLevel(score) {
            if (score < 3) return 'Low Risk';
            if (score < 6) return 'Medium Risk';
            if (score < 8) return 'High Risk';
            return 'Critical Risk';
        }
        

        
        // Load EWS system analysis
        function loadEWSSystemAnalysis(results) {
            // Check if stress_parameters exists
            if (!results.stress_parameters) {
                console.log("No stress_parameters found, skipping EWS system analysis");
                return;
            }
            
            const params = {
                gdp: results.stress_parameters.gdp_shock,
                unemployment: results.stress_parameters.unemployment_shock,
                pce: results.stress_parameters.pce_shock,
                duration: results.stress_parameters.duration
            };
            
            fetch('/api/stress-testing/ews-system', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(params)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayEWSSystemAnalysis(data);
                } else {
                    console.error('Error loading EWS system analysis:', data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
        
        // Display EWS system analysis
        function displayEWSSystemAnalysis(ewsData) {
            // Show EWS system section
            document.getElementById('ews-system-section').style.display = 'block';
            
            // Update historical analysis
            if (ewsData.historical_analysis) {
                document.getElementById('ews-hist-total-warnings').textContent = ewsData.historical_analysis.total_warnings;
                document.getElementById('ews-hist-gdp-warnings').textContent = ewsData.historical_analysis.gdp_warnings;
                document.getElementById('ews-hist-pce-warnings').textContent = ewsData.historical_analysis.pce_warnings;
                document.getElementById('ews-hist-unemp-warnings').textContent = ewsData.historical_analysis.unemployment_warnings;
            }
            
            // Update threshold values
            if (ewsData.thresholds && ewsData.thresholds.raw_units_negative) {
                document.getElementById('ews-gdp-threshold').textContent = (ewsData.thresholds.raw_units_negative.GDP_growth * 100).toFixed(2) + '%';
                document.getElementById('ews-pce-threshold').textContent = (ewsData.thresholds.raw_units_negative.PCE_growth * 100).toFixed(2) + '%';
                document.getElementById('ews-unemp-threshold').textContent = (ewsData.thresholds.raw_units_positive.Unemployment_change * 100).toFixed(2) + '%';
            }
            
            // Create scenario cards
            const scenarioCardsContainer = document.getElementById('ews-scenario-cards');
            scenarioCardsContainer.innerHTML = '';
            
            if (ewsData.scenario_analysis) {
                Object.entries(ewsData.scenario_analysis).forEach(([scenarioName, analysis]) => {
                    const cardHtml = `
                        <div class="col-md-6 mb-3">
                            <div class="card h-100">
                                <div class="card-header ${getScenarioColor(scenarioName)} text-white">
                                    <h6 class="mb-0">${scenarioName}</h6>
                                </div>
                                <div class="card-body text-center">
                                    <div class="mb-2">
                                        <div class="h4 ${getScenarioTextColor(scenarioName)} fw-bold">${analysis.total_warnings}</div>
                                        <small class="text-muted">Total Warnings</small>
                                    </div>
                                    <div class="row text-center">
                                        <div class="col-4">
                                            <div class="h6 text-danger fw-bold">${analysis.gdp_warnings}</div>
                                            <small class="text-muted">GDP</small>
                                        </div>
                                        <div class="col-4">
                                            <div class="h6 text-warning fw-bold">${analysis.pce_warnings}</div>
                                            <small class="text-muted">PCE</small>
                                        </div>
                                        <div class="col-4">
                                            <div class="h6 text-info fw-bold">${analysis.unemployment_warnings}</div>
                                            <small class="text-muted">Unemp</small>
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <small class="text-muted">Max EWS: ${analysis.max_ews_score}/3 | Avg: ${analysis.avg_ews_score.toFixed(1)}</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    scenarioCardsContainer.innerHTML += cardHtml;
                });
            }
            
            // Create EWS score chart
            createEWSScoreChart(ewsData.scenario_analysis);
            
            // Create warning dates section
            createEWSWarningDates(ewsData.scenario_analysis);
        }
        
        // Helper functions for EWS display
        function getScenarioColor(scenarioName) {
            switch(scenarioName) {
                case 'Baseline': return 'bg-secondary';
                case 'Mild Shock': return 'bg-success';
                case 'Moderate Shock': return 'bg-warning';
                case 'Severe Shock': return 'bg-danger';
                case 'Custom Shock': return 'bg-primary';
                default: return 'bg-light';
            }
        }
        
        function getScenarioTextColor(scenarioName) {
            switch(scenarioName) {
                case 'Baseline': return 'text-dark';
                case 'Mild Shock': return 'text-dark';
                case 'Moderate Shock': return 'text-dark';
                case 'Severe Shock': return 'text-dark';
                case 'Custom Shock': return 'text-dark';
                default: return 'text-dark';
            }
        }
        
        // Create EWS score chart
        function createEWSScoreChart(scenarioAnalysis) {
            if (!scenarioAnalysis) return;
            
            const traces = [];
            const colors = {
                'Baseline': '#6c757d',
                'Mild Shock': '#28a745',
                'Moderate Shock': '#ffc107',
                'Severe Shock': '#dc3545',
                'Custom Shock': '#007bff'
            };
            
            Object.entries(scenarioAnalysis).forEach(([scenarioName, analysis]) => {
                if (analysis.dates && analysis.ews_scores) {
                    traces.push({
                        x: analysis.dates,
                        y: analysis.ews_scores,
                        type: 'scatter',
                        mode: 'lines+markers',
                        name: scenarioName,
                        line: { color: colors[scenarioName] || '#000000', width: 2 },
                        marker: { size: 6 }
                    });
                }
            });
            
            const layout = {
                title: 'EWS Score Over Time',
                xaxis: { title: 'Date' },
                yaxis: { title: 'EWS Score (0-3)', range: [0, 3.5] },
                height: 200,
                margin: { t: 30, b: 30, l: 40, r: 20 }
            };
            
            Plotly.newPlot('ews-score-chart', traces, layout, {responsive: true});
        }
        
        // Create warning dates section
        function createEWSWarningDates(scenarioAnalysis) {
            const warningDatesContainer = document.getElementById('ews-warning-dates');
            warningDatesContainer.innerHTML = '';
            
            if (!scenarioAnalysis) return;
            
            Object.entries(scenarioAnalysis).forEach(([scenarioName, analysis]) => {
                const colHtml = `
                    <div class="col-md-3 mb-3">
                        <div class="card">
                            <div class="card-header ${getScenarioColor(scenarioName)} text-white">
                                <h6 class="mb-0">${scenarioName}</h6>
                            </div>
                            <div class="card-body">
                                <div class="small">
                                    <div class="mb-1"><strong>GDP:</strong> <span class="text-danger">${analysis.warning_dates.GDP_growth.length > 0 ? analysis.warning_dates.GDP_growth.join(', ') : 'No warnings'}</span></div>
                                    <div class="mb-1"><strong>PCE:</strong> <span class="text-warning">${analysis.warning_dates.PCE_growth.length > 0 ? analysis.warning_dates.PCE_growth.join(', ') : 'No warnings'}</span></div>
                                    <div class="mb-1"><strong>Unemployment:</strong> <span class="text-info">${analysis.warning_dates.Unemployment_change.length > 0 ? analysis.warning_dates.Unemployment_change.join(', ') : 'No warnings'}</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                warningDatesContainer.innerHTML += colHtml;
            });
        }
        

        

        
        // Show/hide loading state
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('stress-results').style.display = 'none';
        }
        
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }
        
        // Export data function
        function exportData() {
            if (currentResults) {
                // Create CSV content
                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "Time Period,GDP Impact,Unemployment Impact,Consumption Impact\n";
                
                for (let i = 0; i < currentResults.time_periods.length; i++) {
                    csvContent += `${currentResults.time_periods[i]},${currentResults.gdp_trajectory[i]},${currentResults.unemployment_trajectory[i]},${currentResults.consumption_trajectory[i]}\n`;
                }
                
                // Download file
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "stress_testing_results.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                alert('Run stress test first to export data.');
            }
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Stress Testing page loaded');
            
            // Set current date
            const currentDate = new Date().toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            const dateElement = document.querySelector('#current-date');
            if (dateElement) {
                dateElement.textContent = currentDate;
            }
            
            // Event listeners for comprehensive chart
            document.getElementById('update-chart').addEventListener('click', function() {
                if (currentResults) {
                    loadComprehensiveChartData(currentResults);
                }
            });
            
            document.getElementById('chart-indicator').addEventListener('change', function() {
                if (currentResults) {
                    loadComprehensiveChartData(currentResults);
                }
            });
        });
    </script>
</body>
</html> 